% This is a test to check the accuracy of the method, by locating
% the optic disk

close all, clear all

optLoc = [ 0.44, 0.49; % D5.4
           0.46, 0.49; % D5.6
           0.48, 0.53; % Ret22.2
           0.45, 0.51; % Ret22.3
           0.49, 0.50; % Ret22.6
           0.50, 0.54; % Ret22.8
           0.46, 0.47; % Ret22.9
           0.54, 0.46; % Ret32.1
           0.52, 0.47]; % Ret32.2


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% We also want to load data from Retistruct
% Taken from Sterratt et al 2013
% DS-RetistructOpticDisk.csv -- 
% The columns you need to look at are OD.phi and OD.lambda. OD.phi is the
% latitude (not colatitude) of points in radians and OD.lambda the
% longitude in radians.

                %  OD.phi     OD.lambda
DSphiLambda = [-1.422970827	0.718468072
               -1.470107551	0.461531575
               -1.43117608	0.963955805
               -1.436870956	1.762548056
               -1.476105797	2.459618239
               -1.495253636	-3.132000784
               -1.508583326	1.057991225
               -1.447533721	1.166139185
               -1.48212306	1.280341915
               -1.42924546	2.093744362
               -1.457551394	0.590924866
               -1.462236135	1.487009153
               -1.355248549	1.65639033
               -1.442153894	0.535539145
               -1.391113394	2.164451424
               -1.346531705	1.908497441
               -1.469594107	1.432662361
               -1.454705369	0.688522524
               -1.457826498	1.991547612
               -1.457652563	1.597189135
               -1.494896378	-0.80966081
               -1.519376142	2.422538824
               -1.460116071	0.615395691
               -1.466408326	2.176180921
               -1.484771854	-2.403368076
               -1.399816014	0.620693441
               -1.416516864	1.008527417
               -1.512067767	-2.186968464
               -1.463486766	2.169719263
               -1.4470064	2.056129062
               -1.426090519	2.108156671
               -1.463181079	1.864748589
               -1.311195801	1.53338488
               -1.46168994	0.94545119
               -1.413847228	1.81373472
               -1.507233503	-2.22677615
               -1.385621307	0.286519989
               -1.385000096	1.361642224
               -1.430163162	1.558554328
               -1.322022973	1.880723231
               -1.459761129	-2.588333076
               -1.472178478	1.656421358
               -1.464451129	-0.336417107
               -1.435336688	2.429590563
               -1.465356198	-1.898996026
               -1.466516074	-2.277710531
               -1.44692914	1.115654085
               -1.225548076	-2.704371518
               -1.484933406	1.128328341
               -1.434804073	-2.94849515
               -1.478089689	1.559299686
               -1.484265508	-2.848413045
               -1.379523841	-0.228347586
               -1.316962072	-1.04888908
               -1.465078738	2.865179739
               -1.32842921	1.885316316
               -1.446633046	1.785737612
               -1.457592101	-3.059534755
               -1.507897938	1.659869087
               -1.445212941	0.812230464
               -1.351902809	-2.81068655
               -1.438374629	1.98175401
               -1.39643508	1.078246178
               -1.505531507	1.998735076
               -1.310081246	-0.614778198
               -1.396237138	2.941116923
               -1.473359531	2.227068701
               -1.428942826	1.907391219
               -1.460013515	1.324453242
               -1.479868314	2.139683233
               -1.514632725	0.074011177
               -1.46081385	1.012488763];


DSrimAngle = [21.56
              21.57
              21.56
              21.56
              21.57
              21.56
              21.56
              21.56
              21.56
              21.56
              21.56
              21.57
              21.57
              21.57
              22
              22
              22
              22
              22
              22
              22
              22
              21.57
              22
              21.6
              21.57
              21.57
              22
              22
              22
              22
              22
              22
              22
              22
              22
              22
              22
              21.56
              22
              22
              21.56
              22
              21.56
              22
              22
              21.56
              21.56
              22
              22
              22
              22
              22
              22
              22
              21.56
              22
              22
              22
              22
              22
              22
              22
              22
              22
              22
              21.56
              21.56
              22
              22
              22
              22];

DSrimAngle = pi/2 - DSrimAngle*pi/180;

DSphi = pi/2 - DSphiLambda(:,1);
DSlambda = DSphiLambda(:,2);
DSx = sin(DSphi).*cos(DSlambda);
DSy = sin(DSphi).*sin(DSlambda);
DSz = cos(DSphi);

es = EyeSphere([],[],[]);
es.radius = [1 1 1];
es.rimAngle = pi/2 - mean(DSrimAngle)*pi/180;
[DSfNT,DSfDV] = es.dualWedgeCoordinates([DSx DSy DSz]);


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
figure, hold on

% Instead of point, plot a disc with diameter 8% of total axis, so
% radius 0.04 (Sterratt et al, 2013 Retistruct estimation of error)
% plot(50,50,'r*','markersize',15)
v = linspace(0,2*pi,30);
x = 4*cos(v)+50;
y = 4*sin(v)+50;
f = fill(x,y,[1 0 0]);
set(f,'linestyle','none')

pDS = plot(DSfNT*100,DSfDV*100,'o','color',[1 1 1]*0.5,'markersize',10,'linewidth',2)
pIE = plot(optLoc(:,1)*100,optLoc(:,2)*100,'k.','markersize',30)

legend([pDS,pIE],'Retistruct','IntactEye')


%


xlabel('Nasotemporal (%)','fontsize',24)
ylabel('Dorsoventral (%)','fontsize',24)
set(gca,'fontsize',22)

a = axis;

a(1) = min(a(1),40);
a(2) = max(a(2),55);
a(3) = min(a(3),45);
a(4) = max(a(4),55);

% dx = max(abs(a(1)-50),abs(a(2)-50));
% dy = max(abs(a(3)-50),abs(a(4)-50));
%
% axis([50-dx 50+dx 50-dy 50+dy])

%axis(a)
axis equal
axis([30 70 30 70])
grid on

set(gca,'ytick',30:10:70)
set(gca,'xtick',30:10:70)

saveas(gcf,'FIGS/optic-disk-location.pdf','pdf')


meanOptLoc = mean(optLoc);
stdOptLoc = std(optLoc);

fprintf('Optic disk: NT: %.0f +/- %.0f DV  %.0f +/- %.0f\n', ...
        100*meanOptLoc(1), 100*stdOptLoc(1), 100*meanOptLoc(2), 100*stdOptLoc(2))